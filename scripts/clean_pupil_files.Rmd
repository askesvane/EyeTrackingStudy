---
title: "clean_pupil_files"
author: "Aske Svane Qvist"
date: "15 April 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Gather all the data from pupil (the Eye-Tracker)

In this script, all the output files from the Eye-Tracker will be cleaned up and gathered in a single csv-file. Redundant columns will be dropped and participantID and block number from the filename will be added to columns in the dataframe. These correspond to the participantID and block columns in the 'pupil_cleaned' script and will thus enable merging the data. The final dataframe will be saved as 'pupil_cleaned.csv' in the folder 'gathered_files'.

## Packages
```{r}
# I use pacman to import packages
library(pacman)
p_load(tidyverse, stringi, janitor)

```

## Import pupil data
```{r}
# Save path to the csv files
path <- "../data/Pupil_Labs_raw_data/"

# Create list of filenames
filenames_pupil <- list.files(path = path, pattern = ".csv")

# Create empty dataframes with appropriate column names
data_clean <- tibble()

# Loop over all files in the folder and combine into one great dataframe.
for (i in 1:length(filenames_pupil)){
  
  # Get filenames one at a time
  filename <- filenames_pupil[i]
  
  # Get ID and block from filename
  participantID <- as.numeric(regmatches(filename, regexpr("[0-9]*[0-9]", filename)))
  block <- as.numeric(stri_extract_last_regex(filename, "\\d{1}"))
  
  # Import data from filename
  filepath = paste(path, filename, sep = "")
  pupil <- read_csv(filepath)
  
  # Create ID and block columns and drop unnecessary column from the raw file (id and base_data)
  pupil <- pupil %>% 
    mutate(
      participantID = participantID,
      block = block) %>% 
    # Drop unnecessary columns and only select relevant ones
    dplyr::select(2,3,4,5,6,7,9,15,16) 

  # append data to df outside the loop
  if (nrow(data_clean) == 0) {
    data_clean <- pupil}
  else {
    data_clean <- rbind(data_clean, pupil)}
}


```

## Overview, write to csv and clean environment
```{r}
# Quick overview to spot potential mistakes
summary <- data_clean %>% 
  group_by(participantID, block) %>% 
  summarise(fixations = n())

# save as csv file
write_csv(data_clean,"../data/gathered_files/pupil_cleaned.csv")


# remove temporary loop objects from the environment
rm(pupil, block, filename, filenames_pupil, filepath, i, participantID, path, summary, data_clean)

```





